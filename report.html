<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-5xl mx-auto py-10" id="reportContent">
    <h1 class="text-2xl font-bold mb-6 text-center">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó</h1>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
      <table class="w-full border-collapse hidden" id="faqTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="border px-4 py-2 text-left">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
            <th class="border px-4 py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
      <canvas id="faqChart"></canvas>
    </div>

    <div class="text-center">
      <button id="downloadPdf" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
    </div>
  </div>

<script>
const SHEET_ID = '1oVKjANdnS0BeBiT-EMjbk8SUIBXDRL5datFd4Wp'; // ‡πÉ‡∏™‡πà ID ‡∏Ç‡∏≠‡∏á Google Sheet ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const RANGE = '‡∏ä‡∏µ‡∏ó1!A1:B10'; // ‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
const API_KEY = 'AIzaSyA98s0js2M4D9y4MGZE4qwnrFTah45jRoQ'; // ‡πÉ‡∏™‡πà API Key

let chartInstance;

async function fetchSheetData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/1oVKjANdnS0BeBiT-EMjbk8SUIBXDRL5datFd4Wp/values/‡∏ä‡∏µ‡∏ó1!A1:B10?key=AIzaSyA98s0js2M4D9y4MGZE4qwnrFTah45jRoQ`;
  const res = await fetch(url);
  const data = await res.json();
  if(!data.values || data.values.length < 2) return [];
  
  const headers = data.values[0];
  return data.values.slice(1).map(row => ({
    question: row[0],
    count: Number(row[1])
  }));
}

async function renderReport() {
  const rows = await fetchSheetData();
  if(rows.length === 0) {
    document.getElementById('faqTable').parentElement.insertAdjacentHTML('afterbegin', 
      '<p class="text-center text-red-500 font-semibold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet</p>'
    );
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const table = document.getElementById('faqTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="border px-4 py-2">${r.question}</td>
                    <td class="border px-4 py-2 text-center">${r.count}</td>`;
    tbody.appendChild(tr);
  });
  table.classList.remove('hidden');

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
  const ctx = document.getElementById('faqChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
  gradient.addColorStop(1, 'rgba(59, 130, 246, 0.3)');
  
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(r => r.question),
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        data: rows.map(r => r.count),
        backgroundColor: gradient,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { enabled: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

renderReport();

// ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
document.getElementById('downloadPdf').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const element = document.getElementById('reportContent');
  const originalWidth = element.style.width;
  element.style.width = '794px'; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì A4

  const canvas = await html2canvas(element, { scale: 3 });
  element.style.width = originalWidth;

  const imgData = canvas.toDataURL('image/png');
  const imgProps = doc.getImageProperties(imgData);
  const pdfWidth = doc.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  doc.save('report_chatbot.pdf');
});
</script>
</body>
</html>
