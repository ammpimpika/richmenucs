<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-5xl mx-auto py-10" id="reportContent">
    <h1 class="text-2xl font-bold mb-6 text-center">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó</h1>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
      <table class="w-full border-collapse hidden" id="faqTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="border px-4 py-2 text-left">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
            <th class="border px-4 py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
      <canvas id="faqChart"></canvas>
    </div>

    <div class="text-center">
      <button id="downloadPdf" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
    </div>
  </div>

<script>
const SHEET_ID = '1oVKjANdnS0BeBiT-EMjbk8SUIBXDBLR5datFd4Dp4Wc';
const RANGE = 'Sheet1!A1:B100';
const API_KEY = 'AIzaSyA98s0js2M4D9y4MGZE4qwnrFTah45jRoQ';

let chartInstance;

async function fetchSheetData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.values || data.values.length < 2) return [];

  // ‡∏î‡∏∂‡∏á column ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô column A)
  const questions = data.values.slice(1).map(r => r[0].trim());

  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  const counts = {};
  questions.forEach(q => {
    counts[q] = (counts[q] || 0) + 1;
  });

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á object { question, count }
  const rows = Object.keys(counts).map(q => ({ question: q, count: counts[q] }));
  rows.sort((a, b) => b.count - a.count);
  return rows;
}

async function renderReport() {
  const rows = await fetchSheetData();
  if(rows.length === 0) {
    document.getElementById('faqTable').parentElement.insertAdjacentHTML('afterbegin', 
      '<p class="text-center text-red-500 font-semibold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet</p>'
    );
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const table = document.getElementById('faqTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="border px-4 py-2">${r.question}</td>
                    <td class="border px-4 py-2 text-center">${r.count}</td>`;
    tbody.appendChild(tr);
  });
  table.classList.remove('hidden');

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
  const ctx = document.getElementById('faqChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
  gradient.addColorStop(1, 'rgba(59, 130, 246, 0.3)');
  
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(r => r.question),
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        data: rows.map(r => r.count),
        backgroundColor: gradient,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { enabled: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

renderReport();

// ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
document.getElementById('downloadPdf').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');

  // clone ‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const tableDiv = document.getElementById('faqTable').parentElement;
  const clone = tableDiv.cloneNode(true);

  // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà count <= 1
  const rows = clone.querySelectorAll('tbody tr');
  rows.forEach(tr => {
    const count = parseInt(tr.children[1].textContent);
    if (count <= 1) tr.remove();
  });

  // append clone ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô DOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠ html2canvas capture
  clone.style.position = 'absolute';
  clone.style.left = '-9999px';
  clone.style.width = '794px';
  document.body.appendChild(clone);

  // capture
  const canvas = await html2canvas(clone, { scale: 3, useCORS: true });

  // ‡∏•‡∏ö clone ‡∏´‡∏•‡∏±‡∏á capture
  document.body.removeChild(clone);

  const imgData = canvas.toDataURL('image/png');
  const pdfWidth = doc.internal.pageSize.getWidth();
  const pdfHeight = doc.internal.pageSize.getHeight();
  const imgHeight = (canvas.height * pdfWidth) / canvas.width;

  let heightLeft = imgHeight;
  let position = 0;

  doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
  heightLeft -= pdfHeight;

  while (heightLeft > 0) {
    position = heightLeft - imgHeight;
    doc.addPage();
    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
    heightLeft -= pdfHeight;
  }

  doc.save('report_chatbot.pdf');
});

</script>
</body>
</html>
