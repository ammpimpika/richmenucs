<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheets</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-5xl mx-auto py-10" id="reportContent">
    <h1 class="text-2xl font-bold mb-6 text-center">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó</h1>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
      <table class="w-full border-collapse hidden" id="faqTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="border px-4 py-2 text-left">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
            <th class="border px-4 py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h2>
      <canvas id="faqChart"></canvas>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö -->
    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <h2 class="text-lg font-semibold mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</h2>
      
      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
      <div class="bg-gray-50 p-4 rounded-lg mb-4">
        <h3 class="text-md font-medium mb-3">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div class="flex flex-wrap gap-4 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
            <input type="date" id="dateFrom" class="border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
            <input type="date" id="dateTo" class="border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö:</label>
            <select id="pageFilter" class="border border-gray-300 rounded px-3 py-2">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
          </div>
          <button id="filterVisitors" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>

      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
      <div class="bg-blue-50 p-4 rounded-lg mb-4">
        <h3 class="text-md font-medium mb-2">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600" id="totalVisits">0</div>
            <div class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600" id="totalPages">0</div>
            <div class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-600" id="totalDays">0</div>
            <div class="text-sm text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-orange-600" id="avgVisits">0</div>
            <div class="text-sm text-gray-600">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</div>
          </div>
        </div>
      </div>

      <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏° -->
      <div class="mb-4">
        <h3 class="text-md font-medium mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300" id="visitorTable">
            <thead>
              <tr class="bg-gray-200">
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="border border-gray-300 px-4 py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö -->
      <div class="mb-4">
        <h3 class="text-md font-medium mb-2">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</h3>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300" id="pageSummaryTable">
            <thead>
              <tr class="bg-gray-200">
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</th>
                <th class="border border-gray-300 px-4 py-2 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                <th class="border border-gray-300 px-4 py-2 text-center">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏° -->
      <div>
        <h3 class="text-md font-medium mb-2">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</h3>
        <canvas id="visitorChart"></canvas>
      </div>
    </div>

    <div class="text-center">
      <button id="downloadPdf" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
    </div>
  </div>

<script>
const SHEET_ID = '1oVKjANdnS0BeBiT-EMjbk8SUIBXDBLR5datFd4Dp4Wc';
const RANGE = 'Sheet1!A1:B100';
const API_KEY = 'AIzaSyA98s0js2M4D9y4MGZE4qwnrFTah45jRoQ';

let chartInstance;
let visitorChartInstance;



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
async function fetchVisitorData(dateFrom, dateTo, pageFilter) {
  try {
    const params = new URLSearchParams();
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (pageFilter) params.append('page', pageFilter);
    
    const response = await fetch(`api/visitor_report.php?${params}`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('Error fetching visitor data:', error);
    return { visitors: [], summary: {} };
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
async function renderVisitorReport() {
  const dateFrom = document.getElementById('dateFrom').value || new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  const dateTo = document.getElementById('dateTo').value || new Date().toISOString().split('T')[0];
  const pageFilter = document.getElementById('pageFilter').value;
  
  const data = await fetchVisitorData(dateFrom, dateTo, pageFilter);
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  document.getElementById('totalVisits').textContent = data.summary.total_visits || 0;
  document.getElementById('totalPages').textContent = data.summary.total_pages || 0;
  document.getElementById('totalDays').textContent = data.summary.total_days || 0;
  document.getElementById('avgVisits').textContent = data.summary.avg_visits || 0;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  const visitorTable = document.getElementById('visitorTable').querySelector('tbody');
  visitorTable.innerHTML = '';
  
  if (data.visitors && data.visitors.length > 0) {
    data.visitors.forEach(visitor => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border border-gray-300 px-4 py-2">${visitor.page_name}</td>
        <td class="border border-gray-300 px-4 py-2">${visitor.visit_date}</td>
        <td class="border border-gray-300 px-4 py-2 text-center">${visitor.count}</td>
      `;
      visitorTable.appendChild(row);
    });
  } else {
    visitorTable.innerHTML = '<tr><td colspan="3" class="border border-gray-300 px-4 py-2 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
  const pageSummaryTable = document.getElementById('pageSummaryTable').querySelector('tbody');
  pageSummaryTable.innerHTML = '';
  
  if (data.page_summary && data.page_summary.length > 0) {
    data.page_summary.forEach(page => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border border-gray-300 px-4 py-2">${page.page_name}</td>
        <td class="border border-gray-300 px-4 py-2 text-center">${page.total_count}</td>
        <td class="border border-gray-300 px-4 py-2 text-center">${page.percentage}%</td>
      `;
      pageSummaryTable.appendChild(row);
    });
  } else {
    pageSummaryTable.innerHTML = '<tr><td colspan="3" class="border border-gray-300 px-4 py-2 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  if (data.page_summary && data.page_summary.length > 0) {
    const ctx = document.getElementById('visitorChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(34, 197, 94, 0.8)');
    gradient.addColorStop(1, 'rgba(34, 197, 94, 0.3)');
    
    if (visitorChartInstance) visitorChartInstance.destroy();
    visitorChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.page_summary.map(p => p.page_name),
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°',
          data: data.page_summary.map(p => p.total_count),
          backgroundColor: gradient,
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false }, 
          tooltip: { enabled: true } 
        },
        scales: { 
          y: { beginAtZero: true } 
        }
      }
    });
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
async function loadPageList() {
  try {
    const response = await fetch('api/visitor_pages.php');
    const data = await response.json();
    
    const pageFilter = document.getElementById('pageFilter');
    pageFilter.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
    
    if (data.pages && data.pages.length > 0) {
      data.pages.forEach(page => {
        const option = document.createElement('option');
        option.value = page;
        option.textContent = page;
        pageFilter.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error loading page list:', error);
  }
}

async function fetchSheetData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.values || data.values.length < 2) return [];

  // ‡∏î‡∏∂‡∏á column ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô column A)
  const questions = data.values.slice(1).map(r => r[0].trim());

  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  const counts = {};
  questions.forEach(q => {
    counts[q] = (counts[q] || 0) + 1;
  });

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á object { question, count }
  const rows = Object.keys(counts).map(q => ({ question: q, count: counts[q] }));
  rows.sort((a, b) => b.count - a.count);
  return rows;
}

async function renderReport() {
  const rows = await fetchSheetData();
  if(rows.length === 0) {
    document.getElementById('faqTable').parentElement.insertAdjacentHTML('afterbegin', 
      '<p class="text-center text-red-500 font-semibold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheet</p>'
    );
    return;
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  const table = document.getElementById('faqTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="border px-4 py-2">${r.question}</td>
                    <td class="border px-4 py-2 text-center">${r.count}</td>`;
    tbody.appendChild(tr);
  });
  table.classList.remove('hidden');

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
  const ctx = document.getElementById('faqChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
  gradient.addColorStop(1, 'rgba(59, 130, 246, 0.3)');
  
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(r => r.question),
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        data: rows.map(r => r.count),
        backgroundColor: gradient,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: { enabled: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

renderReport();

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
loadPageList();
renderVisitorReport();


// Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
document.getElementById('filterVisitors').addEventListener('click', renderVisitorReport);

// ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
document.getElementById('downloadPdf').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤
  const pdfWidth = doc.internal.pageSize.getWidth();
  const pdfHeight = doc.internal.pageSize.getHeight();
  const margin = 40;
  let yPosition = margin;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó', pdfWidth / 2, yPosition, { align: 'center' });
  yPosition += 40;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  const currentDate = new Date().toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  doc.text(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${currentDate}`, margin, yPosition);
  yPosition += 30;

  // ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text('‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°', margin, yPosition);
  yPosition += 30;

  // clone ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  const faqTableDiv = document.getElementById('faqTable').parentElement;
  const faqClone = faqTableDiv.cloneNode(true);

  // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà count <= 1
  const faqRows = faqClone.querySelectorAll('tbody tr');
  faqRows.forEach(tr => {
    const count = parseInt(tr.children[1].textContent);
    if (count <= 1) tr.remove();
  });

  // append clone ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô DOM
  faqClone.style.position = 'absolute';
  faqClone.style.left = '-9999px';
  faqClone.style.width = '794px';
  document.body.appendChild(faqClone);

  // capture ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  const faqCanvas = await html2canvas(faqClone, { scale: 2, useCORS: true });
  document.body.removeChild(faqClone);

  const faqImgData = faqCanvas.toDataURL('image/png');
  const faqImgHeight = (faqCanvas.height * (pdfWidth - 2 * margin)) / faqCanvas.width;

  if (yPosition + faqImgHeight > pdfHeight - margin) {
    doc.addPage();
    yPosition = margin;
  }

  doc.addImage(faqImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, faqImgHeight);
  yPosition += faqImgHeight + 30;

  // ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö', margin, yPosition);
  yPosition += 30;

  // ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  const totalVisits = document.getElementById('totalVisits').textContent;
  const totalPages = document.getElementById('totalPages').textContent;
  const totalDays = document.getElementById('totalDays').textContent;
  const avgVisits = document.getElementById('avgVisits').textContent;

  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalVisits} ‡∏Ñ‡∏ô`, margin, yPosition);
  yPosition += 20;
  doc.text(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö: ${totalPages} ‡∏´‡∏ô‡πâ‡∏≤`, margin, yPosition);
  yPosition += 20;
  doc.text(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô: ${totalDays} ‡∏ß‡∏±‡∏ô`, margin, yPosition);
  yPosition += 20;
  doc.text(`‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô: ${avgVisits} ‡∏Ñ‡∏ô`, margin, yPosition);
  yPosition += 30;

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°', margin, yPosition);
  yPosition += 30;

  const visitorTableDiv = document.getElementById('visitorTable').parentElement;
  const visitorClone = visitorTableDiv.cloneNode(true);

  visitorClone.style.position = 'absolute';
  visitorClone.style.left = '-9999px';
  visitorClone.style.width = '794px';
  document.body.appendChild(visitorClone);

  const visitorCanvas = await html2canvas(visitorClone, { scale: 2, useCORS: true });
  document.body.removeChild(visitorClone);

  const visitorImgData = visitorCanvas.toDataURL('image/png');
  const visitorImgHeight = (visitorCanvas.height * (pdfWidth - 2 * margin)) / visitorCanvas.width;

  if (yPosition + visitorImgHeight > pdfHeight - margin) {
    doc.addPage();
    yPosition = margin;
  }

  doc.addImage(visitorImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, visitorImgHeight);
  yPosition += visitorImgHeight + 30;

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö', margin, yPosition);
  yPosition += 30;

  const summaryTableDiv = document.getElementById('pageSummaryTable').parentElement;
  const summaryClone = summaryTableDiv.cloneNode(true);

  summaryClone.style.position = 'absolute';
  summaryClone.style.left = '-9999px';
  summaryClone.style.width = '794px';
  document.body.appendChild(summaryClone);

  const summaryCanvas = await html2canvas(summaryClone, { scale: 2, useCORS: true });
  document.body.removeChild(summaryClone);

  const summaryImgData = summaryCanvas.toDataURL('image/png');
  const summaryImgHeight = (summaryCanvas.height * (pdfWidth - 2 * margin)) / summaryCanvas.width;

  if (yPosition + summaryImgHeight > pdfHeight - margin) {
    doc.addPage();
    yPosition = margin;
  }

  doc.addImage(summaryImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, summaryImgHeight);

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
  doc.save('report_chatbot_complete.pdf');
});
</script>
</body>
</html>
